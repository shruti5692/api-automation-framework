package tests;

import com.framework.utils.ConfigManager;
import com.framework.utils.ExcelUtils;
import com.framework.utils.JwtFetcher;
import okhttp3.*;
import org.json.JSONObject;
import org.testng.Assert;
import org.testng.annotations.DataProvider;
import org.testng.annotations.Test;

import java.util.*;

/**
 * SE78 API automation:
 *  - Validates mandatory field & length checks for ChargeID.
 *  - Reads all scenarios from Excel sheet "SE78" (positive & negative).
 */
public class SE78Test {

    private static final String EXCEL_PATH  =
            System.getProperty("user.dir") + "/src/test/resources/TestData.xlsx";
    private static final String SHEET_NAME  = "SE78";

    @DataProvider(name = "se78Data")
    public Object[][] se78Data() throws Exception {
        List<Map<String,String>> rows = ExcelUtils.readSheet(EXCEL_PATH, SHEET_NAME);
        Object[][] data = new Object[rows.size()][1];
        for (int i = 0; i < rows.size(); i++) data[i][0] = rows.get(i);
        return data;
    }

    @Test(dataProvider = "se78Data")
    public void validateChargeIdRules(Map<String,String> row) throws Exception {

        String testCaseID  = row.get("TestCaseID");
        String chargeId    = row.get("ChargeID");
        String headersJson = row.get("Headers");
        int expectedStatus = Integer.parseInt(row.get("ExpectedStatusCode"));
        String expectedKey = row.get("ExpectedErrorKey");
        String expectedMsg = row.get("ExpectedErrorMsg");

        // --- Build headers directly with org.json ---
        Map<String,String> headers = new LinkedHashMap<>();
        if (headersJson != null && !headersJson.trim().isEmpty()) {
            JSONObject j = new JSONObject(headersJson);
            for (String k : j.keySet()) {
                headers.put(k, j.getString(k));
            }
        }
        headers.put("Content-Type", "application/json");
        headers.put("Accept", "application/json");
        String jwt = JwtFetcher.fetchI2BJwt();   // your existing new JWT method
        headers.put("Authorization", "Bearer " + jwt);
        System.out.println("Fetched JWT: " + jwt);

        // --- Request body ---
        JSONObject body = new JSONObject();
        body.put("ChargeID", chargeId == null ? "" : chargeId.trim());

        RequestBody reqBody = RequestBody.create(
                body.toString(), MediaType.parse("application/json"));

        // Base URL from config.properties
        String baseUrl = ConfigManager.get("se78.base.url");

        Request.Builder reqBuilder = new Request.Builder()
                .url(baseUrl)
                .post(reqBody);

        for (Map.Entry<String,String> e : headers.entrySet()) {
            if (e.getKey() != null && !e.getKey().trim().isEmpty()) {
                reqBuilder.addHeader(e.getKey(), e.getValue());
            }
        }

        OkHttpClient client = new OkHttpClient();
        Response response = client.newCall(reqBuilder.build()).execute();

        int actualStatus = response.code();
        String respBody = response.body() != null ? response.body().string() : "";
        System.out.println("API Response: " + respBody);

        boolean pass;
        if (expectedStatus == 200) {
            pass = (actualStatus == 200);
        } else {
            pass = (actualStatus == expectedStatus);
            if (pass && expectedKey != null && !expectedKey.isEmpty()) {
                JSONObject respJson = new JSONObject(respBody);
                String errKey = respJson.optString("errorKey");
                String errMsg = respJson.optString("errorMessage");
                pass = expectedKey.equalsIgnoreCase(errKey) &&
                       (expectedMsg == null || expectedMsg.isEmpty() || errMsg.contains(expectedMsg));
            }
        }

        ExcelUtils.writeResult(EXCEL_PATH, SHEET_NAME, testCaseID, pass ? "PASS" : "FAIL");

        Assert.assertTrue(pass,
            "Failed TestCase: " + testCaseID + "\nExpectedStatus=" + expectedStatus +
            "\nActualStatus=" + actualStatus + "\nBody=" + respBody);
    }
}
