package tests;

import org.framework.utils.DBUtils;
import org.framework.utils.ExcelUtils;
import org.framework.utils.ResponseValidator;

import java.util.*;

public class CustomerAccountTest {

    public static void main(String[] args) throws Exception {

        String excelPath = "src/test/resources/TestData.xlsx";
        List<Map<String, String>> testRows =
                ExcelUtils.readSheet(excelPath, "TestCases");

        for (Map<String, String> row : testRows) {
            String tcId   = row.get("TestCaseID");
            String custNo = row.get("CustomerIdentificationNumber");

            // 1. Call your API client to get the response map
            Map<String,String> apiData = callCustomerAccountApi(custNo);

            // 2. DB query for this customer
            String sql = "SELECT CUST_NO, PROD_ID, PROD_COD " +
                         "FROM cudprodreln " +
                         "WHERE CUST_NO = ? " +
                         "AND LENGTH(PROD_ID) = 14 " +
                         "AND OPEN_CLO_STA = 'O'";
            List<Map<String,Object>> dbData = DBUtils.executeQuery(sql, custNo);

            // 3. Validate
            boolean pass = ResponseValidator.validateAccount(dbData, apiData);

            // 4. Write result to Excel
            ExcelUtils.writeResult(excelPath, "TestCases", tcId,
                    pass ? "PASS" : "FAIL");
        }
        DBUtils.close();
    }

    private static Map<String,String> callCustomerAccountApi(String custNo) {
        // hit your API & parse only the needed fields
        Map<String,String> m = new HashMap<>();
        m.put("customerNumber", custNo);
        m.put("productCode",   "sampleProd");   // from JSON
        m.put("accountNumber", "12345678901234");
        return m;
    }
}
