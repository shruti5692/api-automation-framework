package tests;

import org.framework.utils.DBUtils;
import java.util.*;

public class DbFetchHelper {

    // Query verified in DBeaver
    private static final String QUERY =
        "SELECT CUST_NO, PROD_ID, PROD_COD " +
        "FROM INTST02.CUD_PROD_RELN " +
        "WHERE CUST_NO = ? " +
        "  AND LENGTH(RTRIM(PROD_ID)) = 14 " +
        "  AND OPEN_CLO_STA = 'O'";

    /**
     * Returns each row as "CUST_NO|PROD_ID|PROD_COD"
     * with PROD_ID already trimmed.
     */
    public static Set<String> fetchCustomerProducts(String customerNumber) throws Exception {
        List<Map<String,Object>> rows = DBUtils.executeQuery(QUERY, customerNumber);

        Set<String> result = new HashSet<>();
        for (Map<String,Object> row : rows) {
            String cust   = String.valueOf(row.get("CUST_NO")).trim();
            String prodId = String.valueOf(row.get("PROD_ID")).trim(); // trim spaces
            String prodCd = String.valueOf(row.get("PROD_COD")).trim();
            result.add(cust + "|" + prodId + "|" + prodCd);
        }
        return result;
    }

    // Quick standalone run for testing
    public static void main(String[] args) throws Exception {
        String customerNo = args.length > 0 ? args[0] : "1104165104";
        Set<String> records = fetchCustomerProducts(customerNo);

        if (records.isEmpty()) {
            System.out.println("No records found for " + customerNo);
        } else {
            System.out.println("DB Records:");
            for (String r : records) {
                System.out.println(r);
            }
        }
    }
}
