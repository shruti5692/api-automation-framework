package org.framework.utils;

import org.framework.config.ConfigManager;
import java.sql.*;
import java.util.*;

public class DBUtils {

    private static Connection getConnection() throws Exception {
        String url  = ConfigManager.get("db.url");
        String user = ConfigManager.get("db.user");
        String pass = ConfigManager.get("db.password");
        Class.forName("com.ibm.db2.jcc.DB2Driver");
        return DriverManager.getConnection(url, user, pass);
    }

    /** Execute any SELECT and return List of Map<column,value>. */
    public static List<Map<String,Object>> executeQuery(String sql, Object... params) throws Exception {
        try (Connection con = getConnection();
             PreparedStatement ps = con.prepareStatement(sql)) {

            for (int i=0; i<params.length; i++) ps.setObject(i+1, params[i]);

            try (ResultSet rs = ps.executeQuery()) {
                List<Map<String,Object>> rows = new ArrayList<>();
                ResultSetMetaData md = rs.getMetaData();
                int cols = md.getColumnCount();

                while (rs.next()) {
                    Map<String,Object> row = new LinkedHashMap<>();
                    for (int c = 1; c <= cols; c++) {
                        row.put(md.getColumnLabel(c).toLowerCase(), rs.getObject(c));
                    }
                    rows.add(row);
                }
                return rows;
            }
        }
    }
}
