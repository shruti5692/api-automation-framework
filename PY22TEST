package com.framework.tests;

import com.framework.utils.ExcelUtils;
import com.framework.utils.JwtFetcher;
import com.framework.utils.ApiUtils;
import org.testng.annotations.*;

import java.util.*;

public class PY22Test {

    private static final String EXCEL_PATH = "src/test/resources/testdata/PY22Data.xlsx";
    private static final String SHEET_NAME = "PY22";
    private String jwtToken;
    private List<Map<String, String>> allData;

    @BeforeClass
    public void setup() throws Exception {
        System.out.println("========== PY22 Test Execution Started ==========");
        jwtToken = JwtFetcher.getDynamicJwt();
        System.out.println("âœ… JWT fetched successfully");

        // Read once and store
        allData = ExcelUtils.readSheet(EXCEL_PATH, SHEET_NAME);
    }

    @DataProvider(name = "py22Data")
    public Object[][] getData() {
        String caseFilter = System.getProperty("caseId", "ALL").trim();
        List<Object[]> filtered = new ArrayList<>();

        for (Map<String, String> row : allData) {
            if (caseFilter.equalsIgnoreCase("ALL") ||
                caseFilter.equalsIgnoreCase(row.getOrDefault("TestCaseID", ""))) {
                filtered.add(new Object[]{row});
            }
        }
        return filtered.toArray(new Object[0][0]);
    }

    @Test(dataProvider = "py22Data")
    public void callPY22Api(Map<String, String> row) throws Exception {
        String testCaseId = row.getOrDefault("TestCaseID", "");
        System.out.println("\n=== Running TestCase: " + testCaseId + " ===");

        long start = System.currentTimeMillis();
        int actualStatus = ApiUtils.callPY22Endpoint(row, jwtToken);
        long duration = (System.currentTimeMillis() - start) / 1000;

        String expectedStatus = row.getOrDefault("ExpectedStatus", "");
        String result = (String.valueOf(actualStatus).equals(expectedStatus)) ? "PASS" : "FAIL";

        System.out.printf("Expected: %s | Actual: %s | Result: %s | Duration: %d sec%n",
                expectedStatus, actualStatus, result, duration);

        ExcelUtils.writeResultWithDuration(EXCEL_PATH, SHEET_NAME, testCaseId, result, duration);
    }

    @AfterClass
    public void tearDown() {
        System.out.println("========== PY22 Test Execution Completed ==========");
    }
}
