package com.framework.utils;

import java.util.Map;

public class ApiUtils {

    public static void runApiTest(Map<String, String> row) throws Exception {
        String testCaseId = row.getOrDefault("TestCaseID", "").trim();
        String endpoint = row.getOrDefault("Endpoint", "").trim();
        String prodId = row.getOrDefault("PROD_ID", "").trim();

        // 1️⃣ Prepare headers (via helper)
        Map<String, String> headers = HeaderUtils.buildHeaders(prodId);

        // 2️⃣ Fetch JWT token dynamically
        headers.put("X-HSBC-E2E-Trust-Token", JwtFetcher.getToken());

        // 3️⃣ Call API and validate
        int actualStatus = HttpUtils.getStatus(endpoint, headers);
        int expectedStatus = Integer.parseInt(row.getOrDefault("ExpectedStatus", "200"));

        if (actualStatus != expectedStatus) {
            throw new AssertionError(
                "❌ Test " + testCaseId + " failed: Expected " + expectedStatus + " but got " + actualStatus
            );
        }

        System.out.println("✅ " + testCaseId + " passed (" + actualStatus + ")");
    }
}
