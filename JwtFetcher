package utils;

import okhttp3.*;

import java.io.IOException;

public class JwtFetcher {

    // keep your existing fetchStaffJwt() here

    /**
     * Fetch JWT from the iB2B Token Translator service using OkHttp.
     *
     * @return JWT string from the response
     * @throws IOException if the request or response fails
     */
    public static String fetchIb2bJwt() throws IOException {
        OkHttpClient client = new OkHttpClient
                .Builder()
                .build();

        // JSON request body
        String jsonBody = """
            {
              "input_token_state": {
                "token_type": "CREDENTIAL",
                "username": "GB-SVC-UKBEREV",
                "password": "F568-a55f47837"
              },
              "output_token_state": {
                "token_type": "JWT",
                "issued_token1": "issued_token"
              }
            }
            """;

        RequestBody body = RequestBody.create(
                jsonBody,
                MediaType.parse("application/json")
        );

        Request request = new Request.Builder()
                .url("https://cmb-ib2b-dsp-pprod-eu.systems.uk.hsbc:8443/dsp/rest-sts/DSP_iB2B/iB2B_tokenTranslator?_action=translate")
                .post(body)
                .build();

        try (Response response = client.newCall(request).execute()) {
            if (!response.isSuccessful()) {
                throw new IOException("Unexpected HTTP code: " + response.code());
            }

            String respBody = response.body().string();
            // Extract the JWT from the JSON
            // Using a simple regex/JSON parser; choose whichever JSON library you already use
            String jwt = JsonUtils.read(respBody, "output_token_state.issued_token"); 
            // ^ Replace JsonUtils.read(...) with your actual JSON parser (e.g., Jackson, Gson, org.json)

            if (jwt == null || jwt.isEmpty()) {
                throw new IOException("No JWT returned in response: " + respBody);
            }
            return jwt;
        }
    }
}
